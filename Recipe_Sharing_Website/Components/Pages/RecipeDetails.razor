@page "/recipes/{Id:int}"
 

@using Microsoft.EntityFrameworkCore
@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models

@inject IDbContextFactory<AppDbContext> DbFactory
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Nav

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}

@if (_recipe is null && string.IsNullOrWhiteSpace(_error))
{
    <p>Loading...</p>
}
else if (_recipe is not null)
{
    <h3>@_recipe.Title</h3>
    <p>@_recipe.Description</p>

    @if (IsAdmin)
    {
        <button class="btn btn-danger my-3" type="button" @onclick="DeleteRecipe">
            Delete Recipe (Admin)
        </button>
    }

    <hr />

    <h5>Ingredients</h5>

    <ul>
        @foreach (var ri in _ingredients)
        {
            <li>
                @ri.Quantity @ri.Unit - @ri.Ingredient!.Name

                @if (CanEditRecipe)
                {
                    <button class="btn btn-sm btn-danger ms-2"
                            type="button"
                            @onclick="() => RemoveIngredientAsync(ri.RecipeIngredientId)">
                        Remove
                    </button>
                }
            </li>
        }
    </ul>

    @if (CanEditRecipe)
    {
        <EditForm Model="_addIngredient" OnSubmit="AddIngredientAsync" FormName="AddIngredientForm">
            <select class="form-select mb-2" @bind="_addIngredient.IngredientId">
                <option value="0">Select ingredient</option>
                @foreach (var i in _allIngredients)
                {
                    <option value="@i.IngredientId">@i.Name</option>
                }
            </select>

            <input class="form-control mb-2" placeholder="Quantity" @bind="_addIngredient.Quantity" />
            <input class="form-control mb-2" placeholder="Unit" @bind="_addIngredient.Unit" />
            <button class="btn btn-primary" type="submit">Add</button>
        </EditForm>
    }
    else
    {
        <p><i>Only the recipe owner (or admin) can edit ingredients.</i></p>
    }

    <hr />

    <h5>Feedback</h5>

    <ul>
        @foreach (var f in _feedbacks)
        {
            <li>
                <b>@f.Rating/5</b> - @f.Message

                @if (IsAdmin)
                {
                    <button class="btn btn-sm btn-danger ms-2"
                            type="button"
                            @onclick="() => DeleteFeedbackAsync(f.FeedbackId)">
                        Delete
                    </button>
                }
            </li>
        }
    </ul>

    @if (IsLoggedIn)
    {
        <EditForm Model="_feedback" OnSubmit="AddFeedbackAsync" FormName="AddFeedbackForm">
            <input class="form-control mb-2" type="number" min="1" max="5" @bind="_feedback.Rating" />
            <input class="form-control mb-2" placeholder="Message" @bind="_feedback.Message" />
            <button class="btn btn-primary" type="submit">Post</button>
        </EditForm>
    }
    else
    {
        <p><i>Please login to post feedback.</i></p>
    }
}

@code {
    [Parameter] public int Id { get; set; }

    private Recipe? _recipe;
    private List<Ingredient> _allIngredients = new();
    private List<RecipeIngredient> _ingredients = new();
    private List<Feedback> _feedbacks = new();
    private string? _error;

    private IngredientVm _addIngredient = new();
    private FeedbackVm _feedback = new();

    private bool IsLoggedIn =>
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsLoggedIn(ctx.Session);

    private bool IsAdmin =>
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsAdmin(ctx.Session);

    private int? CurrentUserId =>
        HttpContextAccessor.HttpContext is HttpContext ctx
            ? AuthSession.GetUserId(ctx.Session)
            : null;

    private bool IsOwner =>
        _recipe is not null &&
        CurrentUserId is int uid &&
        _recipe.UserId == uid;

    private bool CanEditRecipe => IsAdmin || IsOwner;

    protected override async Task OnInitializedAsync()
    {
        await LoadPageAsync();
    }

    private async Task LoadPageAsync()
    {
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            _recipe = await db.Recipes.FindAsync(Id);

            _allIngredients = await db.Ingredients
                .OrderBy(i => i.Name)
                .ToListAsync();

            _ingredients = await db.RecipeIngredients
                .Include(x => x.Ingredient)
                .Where(x => x.RecipeId == Id)
                .ToListAsync();

            _feedbacks = await db.Feedbacks
                .Where(x => x.RecipeId == Id)
                .OrderByDescending(x => x.FeedbackId)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            _error = ex.ToString();
        }
    }

    private async Task AddIngredientAsync()
    {
        if (!CanEditRecipe) return;
        if (_addIngredient.IngredientId <= 0) return;

        await using var db = await DbFactory.CreateDbContextAsync();

        db.RecipeIngredients.Add(new RecipeIngredient
        {
            RecipeId = Id,
            IngredientId = _addIngredient.IngredientId,
            Quantity = _addIngredient.Quantity ?? "",
            Unit = _addIngredient.Unit ?? ""
        });

        await db.SaveChangesAsync();
        await LoadPageAsync();
    }

    private async Task RemoveIngredientAsync(int recipeIngredientId)
    {
        if (!CanEditRecipe) return;

        await using var db = await DbFactory.CreateDbContextAsync();
        var ri = await db.RecipeIngredients.FindAsync(recipeIngredientId);
        if (ri is null) return;

        db.RecipeIngredients.Remove(ri);
        await db.SaveChangesAsync();

        await LoadPageAsync();
    }

    private async Task AddFeedbackAsync()
    {
        var uid = CurrentUserId;
        if (uid is null)
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        await using var db = await DbFactory.CreateDbContextAsync();

        db.Feedbacks.Add(new Feedback
        {
            RecipeId = Id,
            UserId = uid.Value,
            Rating = _feedback.Rating,
            Message = _feedback.Message ?? ""
        });

        await db.SaveChangesAsync();
        await LoadPageAsync();
    }

    private async Task DeleteFeedbackAsync(int feedbackId)
    {
        if (!IsAdmin) return;

        await using var db = await DbFactory.CreateDbContextAsync();
        var fb = await db.Feedbacks.FindAsync(feedbackId);
        if (fb is null) return;

        db.Feedbacks.Remove(fb);
        await db.SaveChangesAsync();

        await LoadPageAsync();
    }

    private async Task DeleteRecipe()
    {
        if (!IsAdmin) return;

        await using var db = await DbFactory.CreateDbContextAsync();

        var recipe = await db.Recipes.FindAsync(Id);
        if (recipe is null) return;

        var junctionRows = await db.RecipeIngredients.Where(x => x.RecipeId == Id).ToListAsync();
        if (junctionRows.Count > 0) db.RecipeIngredients.RemoveRange(junctionRows);

        var feedbackRows = await db.Feedbacks.Where(x => x.RecipeId == Id).ToListAsync();
        if (feedbackRows.Count > 0) db.Feedbacks.RemoveRange(feedbackRows);

        db.Recipes.Remove(recipe);
        await db.SaveChangesAsync();

        Nav.NavigateTo("/recipes", true);
    }

    private class IngredientVm
    {
        public int IngredientId { get; set; }
        public string? Quantity { get; set; }
        public string? Unit { get; set; }
    }

    private class FeedbackVm
    {
        public int Rating { get; set; } = 5;
        public string? Message { get; set; }
    }
}
