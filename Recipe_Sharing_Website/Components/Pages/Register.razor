@page "/register"
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@using Microsoft.EntityFrameworkCore
@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models

@inject IDbContextFactory<AppDbContext> DbFactory
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Nav

<h3>Register</h3>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}

<EditForm Model="_vm" OnValidSubmit="RegisterUser" FormName="RegisterForm">
    <AntiforgeryToken />

    <div class="mb-2">
        <label>Username</label>
        <InputText class="form-control" @bind-Value="_vm.Username" />
    </div>

    <div class="mb-2">
        <label>Email</label>
        <InputText class="form-control" @bind-Value="_vm.Email" />
    </div>

    <div class="mb-2">
        <label>Password</label>
        <InputText class="form-control" type="password" @bind-Value="_vm.Password" />
    </div>

    <button class="btn btn-primary">Register</button>
</EditForm>

@code {
    private string? _error;

    private RegisterVm _vm = new();

    private async Task RegisterUser()
    {
        try
        {
            if (HttpContextAccessor.HttpContext is not HttpContext ctx)
            {
                _error = "Session unavailable. Refresh and try again.";
                return;
            }

            var username = (_vm.Username ?? "").Trim();
            var email = (_vm.Email ?? "").Trim();
            var password = _vm.Password ?? "";

            if (string.IsNullOrWhiteSpace(username) ||
                string.IsNullOrWhiteSpace(password))
            {
                _error = "Username and password are required.";
                return;
            }

            await using var db = await DbFactory.CreateDbContextAsync();

            // 🔒 Enforce unique username
            if (await db.Users.AnyAsync(u => u.Username == username))
            {
                _error = "Username already exists.";
                return;
            }

            var user = new User
            {
                Username = username,
                Email = email,
                PasswordHash = BCrypt.Net.BCrypt.HashPassword(password)
            };

            db.Users.Add(user);
            await db.SaveChangesAsync();

            // ✅ AUTO-LOGIN
            ctx.Session.SetString(AuthSession.RoleKey, "User");
            ctx.Session.SetString(AuthSession.UserIdKey, user.UserId.ToString());
            ctx.Session.SetString(AuthSession.NameKey, user.Username);

            Nav.NavigateTo("/", true);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private class RegisterVm
    {
        public string? Username { get; set; }
        public string? Email { get; set; }
        public string? Password { get; set; }
    }
}
