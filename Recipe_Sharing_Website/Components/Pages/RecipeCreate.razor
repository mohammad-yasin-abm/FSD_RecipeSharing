@page "/recipes/create"
@using Microsoft.EntityFrameworkCore
@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Nav

<h3>Create Recipe</h3>

@if (!IsLoggedIn)
{
<div class="alert alert-warning">
    You must be logged in to create a recipe.
    <a class="ms-2" href="/login">Login</a>
</div>
@code { }
}
else
{
    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="alert alert-danger">@_error</div>
    }

    @if (!IsPremium && _createdCount >= 1)
    {
        <div class="alert alert-warning">
            Free users can create up to <b>1</b> recipe.
            Please upgrade to Premium to create unlimited recipes.
            <a class="ms-2" href="/premium">Go Premium</a>
        </div>
    }
    else
    {
        <EditForm Model="_vm" OnValidSubmit="CreateRecipe" FormName="CreateRecipeForm">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-3">
                <label class="form-label">Title</label>
                <InputText class="form-control" @bind-Value="_vm.Title" />
            </div>

            <div class="mb-3">
                <label class="form-label">Description</label>
                <InputTextArea class="form-control" rows="2" @bind-Value="_vm.Description" />
            </div>

            <div class="mb-3">
                <label class="form-label">Ingredients (type freely)</label>
                <InputTextArea class="form-control" rows="4" @bind-Value="_vm.IngredientsText" />
                <div class="text-muted" style="font-size:0.9rem;">
                    Example: Chicken 200g, Garlic 2 cloves, Salt 1 tsp...
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Steps (type freely)</label>
                <InputTextArea class="form-control" rows="6" @bind-Value="_vm.StepsText" />
                <div class="text-muted" style="font-size:0.9rem;">
                    Example: 1) Marinate chicken... 2) Pan-fry...
                </div>
            </div>

            <button class="btn btn-primary" type="submit">Create</button>
            <a class="btn btn-outline-secondary ms-2" href="/recipes">Cancel</a>
        </EditForm>
    }
}

@code {
    private string? _error;
    private int _createdCount;

    private CreateVm _vm = new();

    private bool IsLoggedIn =>
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsLoggedIn(ctx.Session);

    private bool IsPremium =>
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        ctx.Session.GetString(AuthSession.RoleKey) == "User" &&
        GetUserId(ctx) > 0 &&
        _isPremiumCached;

    private bool _isPremiumCached = false;

    protected override async Task OnInitializedAsync()
    {
        if (HttpContextAccessor.HttpContext is not HttpContext ctx)
            return;

        if (!AuthSession.IsLoggedIn(ctx.Session))
            return;

        var userId = GetUserId(ctx);
        if (userId <= 0)
            return;

        await using var db = await DbFactory.CreateDbContextAsync();

        // Count how many recipes the user created
        _createdCount = await db.Recipes.CountAsync(r => r.UserId == userId);

        // Load premium flag from DB
        var user = await db.Users.FirstOrDefaultAsync(u => u.UserId == userId);
        _isPremiumCached = user?.IsPremium ?? false;
    }

    private async Task CreateRecipe()
    {
        _error = null;

        if (HttpContextAccessor.HttpContext is not HttpContext ctx)
            return;

        var userId = GetUserId(ctx);
        if (userId <= 0)
        {
            _error = "You must be logged in as a user.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_vm.Title))
        {
            _error = "Title is required.";
            return;
        }

        await using var db = await DbFactory.CreateDbContextAsync();

        // Re-check limits at submit time (avoid bypass via refresh)
        var user = await db.Users.FirstOrDefaultAsync(u => u.UserId == userId);
        if (user is null)
        {
            _error = "User not found.";
            return;
        }

        var createdCount = await db.Recipes.CountAsync(r => r.UserId == userId);

        if (!user.IsPremium && createdCount >= 1)
        {
            _error = "Free users can only create 1 recipe. Please upgrade to Premium.";
            return;
        }

        var recipe = new Recipe
        {
            UserId = userId,
            Title = _vm.Title.Trim(),
            Description = (_vm.Description ?? "").Trim(),
            IngredientsText = (_vm.IngredientsText ?? "").Trim(),
            StepsText = (_vm.StepsText ?? "").Trim()
        };

        db.Recipes.Add(recipe);
        await db.SaveChangesAsync();

        Nav.NavigateTo($"/recipes/{recipe.RecipeId}", true);
    }

    private static int GetUserId(HttpContext ctx)
    {
        var s = ctx.Session.GetString(AuthSession.UserIdKey);
        return int.TryParse(s, out var id) ? id : 0;
    }

    private class CreateVm
    {
        public string Title { get; set; } = "";
        public string? Description { get; set; }
        public string? IngredientsText { get; set; }
        public string? StepsText { get; set; }
    }
}
