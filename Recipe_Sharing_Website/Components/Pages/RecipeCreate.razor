@* Route for the create recipe page *@
@page "/recipes/create"

@* Enable interactive mode without prerender *@
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@* EF Core queries *@
@using Microsoft.EntityFrameworkCore

@* Project data and models *@
@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models

@* Inject database context factory *@
@inject IDbContextFactory<AppDbContext> DbFactory

@* Access session values *@
@inject IHttpContextAccessor HttpContextAccessor

@* Navigation helper for redirects *@
@inject NavigationManager Nav

@* Page heading *@
<h3>Create Recipe</h3>

@* Show errors if present *@
@if (!IsLoggedIn)
{
    <p>You must be logged in to create a recipe.</p>

    <a class="btn btn-primary" href="/login">Login</a>
    <a class="btn btn-outline-secondary ms-2" href="/register">Register</a>
}
else
{
    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="alert alert-danger">@_error</div>
    }

    @* Form bound to the view model, validated on submit *@
    <EditForm Model="_vm" OnValidSubmit="CreateRecipe">
        <div class="mb-2">
            <label>Title</label>
            <InputText class="form-control" @bind-Value="_vm.Title" />
        </div>

        <div class="mb-2">
            <label>Description</label>
            <InputText class="form-control" @bind-Value="_vm.Description" />
        </div>

        <div class="mb-2">
            <label>Ingredients</label>
            <InputTextArea class="form-control" rows="6" @bind-Value="_vm.IngredientsText" />
        </div>

        <div class="mb-2">
            <label>Steps / Instructions</label>
            <InputTextArea class="form-control" rows="8" @bind-Value="_vm.StepsText" />
        </div>

        <button class="btn btn-primary" type="submit">Create</button>
    </EditForm>

}

@code {
    // True if user is logged in (based on session)
    private bool IsLoggedIn =>
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsLoggedIn(ctx.Session);

    // True if user has admin privileges
    private bool IsAdmin =>
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsAdmin(ctx.Session);

    
    
    // Stores UI error messages
    private string? _error;

    // View model for form binding
    private Vm _vm = new();

    // Reads current logged-in user ID from session
    private int? CurrentUserId =>
        HttpContextAccessor.HttpContext?.Session.GetString(AuthSession.UserIdKey) is string s &&
        int.TryParse(s, out var id) ? id : null;

    // Handles form submission logic
    private async Task CreateRecipe()
    {
        try
        {
            _error = null;

            if (!CurrentUserId.HasValue)
            {
                Nav.NavigateTo("/login", true);
                return;
            }

            if (string.IsNullOrWhiteSpace(_vm.Title))
            {
                _error = "Title is required.";
                return;
            }

            await using var db = await DbFactory.CreateDbContextAsync();

            var user = await db.Users.FirstOrDefaultAsync(u => u.UserId == CurrentUserId.Value);
            if (user is null)
            {
                _error = "User not found.";
                return;
            }

            if (!user.IsPremium)
            {
                var createdCount = await db.Recipes.CountAsync(r => r.UserId == user.UserId);
                if (createdCount >= 1)
                {
                    _error = "Free users can create only 1 recipe. Please purchase Premium for unlimited recipes.";
                    return;
                }
            }

            var recipe = new Recipe
            {
                Title = _vm.Title.Trim(),
                Description = _vm.Description?.Trim(),
                IngredientsText = _vm.IngredientsText?.Trim(),
                StepsText = _vm.StepsText?.Trim(),
                UserId = user.UserId
            };

            db.Recipes.Add(recipe);
            await db.SaveChangesAsync();

            Nav.NavigateTo($"/recipes/{recipe.RecipeId}", true);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    // Internal view model class
    private class Vm
    {
        public string? Title { get; set; }
        public string? Description { get; set; }
        public string? IngredientsText { get; set; }
        public string? StepsText { get; set; }
    }
}
