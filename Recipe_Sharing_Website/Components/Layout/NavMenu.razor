@* NavMenu.razor - Sidebar navigation + search *@
@using Recipe_Sharing_Website.Data                         @* AuthSession helpers *@
@using Microsoft.AspNetCore.Components.Web                 @* KeyboardEventArgs *@
@inject IHttpContextAccessor HttpContextAccessor          
@inject NavigationManager Nav                              

@* Top navbar row *@
<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        @* Brand link *@
        <a class="navbar-brand" href="/">RecipeHub</a>

        @* Logged-in username display *@
        <span class="ms-2 text-light">@DisplayName</span>
    </div>
</div>

@* Hamburger toggler (default template behaviour) *@
<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

@* Sidebar container *@
<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column">

        @* Search section *@
        <div class="nav-item px-3 mt-2">
            @* Search input box *@
            <input class="form-control"
                   placeholder="Search recipes..."
                   value="@_search"
                   @oninput="OnSearchInput"
                   @onkeydown="HandleKeyDown" />

            @* Search button - type=button prevents form submission issues *@
            <button type="button"
                    class="btn btn-primary w-100 mt-2"
                    @onclick="GoSearch">
                Search
            </button>
        </div>

        @* Navigation links *@
        <div class="nav-item px-3 mt-3">
            <NavLink class="nav-link" href="/" Match="NavLinkMatch.All">Home</NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="/recipes">Recipes</NavLink>
        </div>

        @* If logged in, show authenticated links *@
        @if (IsLoggedIn)
        {
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="/my-recipes">My Recipes</NavLink>
            </div>

            <div class="nav-item px-3">
                <NavLink class="nav-link" href="/recipes/create">Add Recipe</NavLink>
            </div>

            <div class="nav-item px-3">
                <NavLink class="nav-link" href="/premium">Premium</NavLink>
            </div>

            @* Admin-only link *@
            @if (IsAdmin)
            {
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="/admin">Admin</NavLink>
                </div>
            }

            @* Logout posts to your minimal API auth endpoint *@
            <div class="nav-item px-3">
                <form action="/auth/logout" method="post">
                    <button type="submit" class="nav-link btn btn-link p-0">Logout</button>
                </form>
            </div>
        }
        else
        {
            @* If not logged in, show Login/Register *@
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="/login">Login</NavLink>
            </div>

            <div class="nav-item px-3">
                <NavLink class="nav-link" href="/register">Register</NavLink>
            </div>
        }
    </nav>
</div>

@code {
    private string _search = "";                            // Stores search text typed by user

    private bool IsLoggedIn =>                              // True if session says logged in
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsLoggedIn(ctx.Session);

    private bool IsAdmin =>                                 // True if session says admin
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsAdmin(ctx.Session);

    private string DisplayName                              // Shows username in navbar
    {
        get
        {
            if (HttpContextAccessor.HttpContext is not HttpContext ctx)
                return "";                                  // No HttpContext available

            var name = ctx.Session.GetString(AuthSession.NameKey); // Read session name
            return string.IsNullOrWhiteSpace(name) ? "" : $"({name})"; // Format as (User1)
        }
    }

    private void OnSearchInput(ChangeEventArgs e)            // Updates _search as user types
    {
        _search = e.Value?.ToString() ?? "";                 // Null-safe conversion
    }

    private void GoSearch()                                  // Navigates to Recipes page with query string
    {
        var q = (_search ?? "").Trim();                      // Trim spaces

        if (string.IsNullOrWhiteSpace(q))                    // If blank, show all recipes
        {
            Nav.NavigateTo("/recipes");                      // Navigate without query
            return;
        }

        var encoded = Uri.EscapeDataString(q);               // Encode query safely
        Nav.NavigateTo($"/recipes?q={encoded}");             // Navigate to filtered list
    }

    private void HandleKeyDown(KeyboardEventArgs e)          // Allows Enter key to search
    {
        if (e.Key == "Enter")                                // If Enter pressed
        {
            GoSearch();                                      // Trigger same navigation
        }
    }
}
