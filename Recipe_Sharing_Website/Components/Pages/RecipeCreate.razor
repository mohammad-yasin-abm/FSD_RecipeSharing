@page "/recipes/create"
 

@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models

@inject IDbContextFactory<AppDbContext> DbFactory
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Nav

@if (!IsLoggedIn)
{
    <h3>Create Recipe</h3>
    <p><i>Please login to create a recipe.</i></p>
}
else
{
    <h3>Create Recipe</h3>

    @if (!string.IsNullOrWhiteSpace(_status))
    {
        <div class="alert alert-info">@_status</div>
    }

    <EditForm Model="_vm" OnSubmit="CreateRecipe" FormName="CreateRecipeForm">
        <div class="mb-2">
            <label>Title</label>
            <input class="form-control" @bind="_vm.Title" />
        </div>

        <div class="mb-2">
            <label>Description</label>
            <textarea class="form-control" rows="5" @bind="_vm.Description"></textarea>
        </div>

        <button class="btn btn-primary" type="submit">Create</button>
    </EditForm>
}

@code {
    private bool IsLoggedIn =>
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsLoggedIn(ctx.Session);

    private int? CurrentUserId =>
        HttpContextAccessor.HttpContext is HttpContext ctx
            ? AuthSession.GetUserId(ctx.Session)
            : null;

    private string? _status;
    private CreateRecipeVm _vm = new();

    private async Task CreateRecipe()
    {
        var userId = CurrentUserId;
        if (userId is null)
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        var title = (_vm.Title ?? "").Trim();
        var desc = (_vm.Description ?? "").Trim();

        if (string.IsNullOrWhiteSpace(title))
        {
            _status = "Title is required.";
            return;
        }

        await using var db = DbFactory.CreateDbContext();

        var recipe = new Recipe
        {
            Title = title,
            Description = desc,
            UserId = userId.Value
        };

        db.Recipes.Add(recipe);
        await db.SaveChangesAsync();

        Nav.NavigateTo($"/recipes/{recipe.RecipeId}", true);
    }

    private class CreateRecipeVm
    {
        public string? Title { get; set; }
        public string? Description { get; set; }
    }
}
