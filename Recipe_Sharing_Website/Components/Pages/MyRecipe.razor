@page "/my-recipes"
@using Microsoft.EntityFrameworkCore
@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models
@inject IHttpContextAccessor HttpAccessor
@inject IDbContextFactory<AppDbContext> DbFactory

<h2>My Recipes</h2>

@if (_notLoggedIn)
{
    <p>You must be logged in. <a href="/login">Login</a></p>
}
else if (!string.IsNullOrWhiteSpace(_error))
{
    <p class="text-danger">@_error</p>
}
else if (_recipes is null)
{
    <p>Loading...</p>
}
else if (_recipes.Count == 0)
{
    <p>You haven’t created any recipes yet.</p>
}
else
{
    <ul>
        @foreach (var r in _recipes)
        {
            <li class="mb-2">
                <a href="/recipes/@r.RecipeId">@r.Title</a>
                <a class="btn btn-sm btn-warning ms-2" href="/recipes/edit/@r.RecipeId">Edit</a>
                <a class="btn btn-sm btn-secondary ms-1" href="/recipes/@r.RecipeId">View</a>
            </li>
        }
    </ul>
}

@code {
    private List<Recipe>? _recipes;
    private string? _error;
    private bool _notLoggedIn;

    protected override async Task OnInitializedAsync()
    {
        var session = HttpAccessor.HttpContext?.Session;
        var userId = session is null ? null : AuthSession.GetUserId(session);

        if (session is null || !AuthSession.IsLoggedIn(session) || !userId.HasValue)
        {
            _notLoggedIn = true;
            return;
        }

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            _recipes = await db.Recipes
                .Where(r => r.UserId == userId.Value)
                .OrderByDescending(r => r.RecipeId)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            _error = "Failed to load your recipes: " + ex.Message;
        }
    }
}
