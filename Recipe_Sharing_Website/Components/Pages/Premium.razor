@page "/premium"
@using Microsoft.EntityFrameworkCore
@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Nav

<h3>Premium Membership</h3>

@if (_user is null)
{
    <p>Loading...</p>
}
else if (_user.IsPremium)
{
    <div class="alert alert-success">
        <strong>✅ You are a Premium Member</strong>
        <p>You have unlimited access to create and rate recipes.</p>
    </div>
}
else
{
    <div class="alert alert-info">
        <p>Upgrade to Premium to unlock:</p>
        <ul>
            <li>Unlimited recipe creation</li>
            <li>Unlimited recipe ratings</li>
        </ul>

        <button class="btn btn-primary" @onclick="PayForPremium">Upgrade to Premium</button>
    </div>
}

@code {
    private User? _user;

    protected override async Task OnInitializedAsync()
    {
        if (HttpContextAccessor.HttpContext is not HttpContext ctx ||
            !AuthSession.IsLoggedIn(ctx.Session) ||
            AuthSession.IsAdmin(ctx.Session))
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        var userId = AuthSession.GetUserId(ctx.Session);
        if (userId is null)
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        await using var db = await DbFactory.CreateDbContextAsync();
        _user = await db.Users.FirstOrDefaultAsync(u => u.UserId == userId.Value);

        if (_user is null)
            Nav.NavigateTo("/login", true);
    }

    private async Task PayForPremium()
    {
        if (_user is null) return;

        await using var db = await DbFactory.CreateDbContextAsync();

        var user = await db.Users.FirstAsync(u => u.UserId == _user.UserId);
        user.IsPremium = true;

        db.Payments.Add(new Payment
        {
            UserId = user.UserId,
            Amount = 9.99m,
            Status = "Success"
        });

        await db.SaveChangesAsync();

        _user.IsPremium = true;

        if (HttpContextAccessor.HttpContext is HttpContext ctx)
            ctx.Session.SetString(AuthSession.PremiumKey, "true");
    }
}
