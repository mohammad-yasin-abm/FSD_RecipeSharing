@page "/recipes/edit/{RecipeId:int}"                      
@using Microsoft.EntityFrameworkCore                      @* EF Core async queries *@
@using Recipe_Sharing_Website.Data                        @* AuthSession + AppDbContext *@
@using Recipe_Sharing_Website.Models                      @* Recipe model *@
@inject IHttpContextAccessor HttpAccessor                 
@inject IDbContextFactory<AppDbContext> DbFactory         
@inject NavigationManager Nav                             

<h2>Edit Recipe</h2>                                      @* Page header *@

@if (_notLoggedIn)                                        @* If user is not logged in *@
{
    <p>You must be logged in to edit recipes. <a href="/login">Login</a></p> @* Prompt login *@
}
else if (!string.IsNullOrWhiteSpace(_error))              @* If error exists *@
{
    <p class="text-danger">@_error</p>                    @* Display error text *@
}
else if (_recipe is null)                                 @* If recipe still loading *@
{
    <p>Loading...</p>                                     @* Loading message *@
}
else if (!_canEdit)                                       @* If user does not have permission *@
{
    <p class="text-danger">You are not allowed to edit this recipe.</p> @* Permission message *@
    <a class="btn btn-secondary" href="/recipes/@RecipeId">Back</a>     @* Back link *@
}
else                                                      @* Allowed to edit *@
{
    <EditForm Model="_recipe" OnValidSubmit="SaveAsync">   @* Form posts to SaveAsync *@
        <DataAnnotationsValidator />                       @* Enables validation attributes *@
        <ValidationSummary />                              @* Shows validation errors *@

        <div class="mb-3">                                 @* Title input block *@
            <label class="form-label">Title</label>        @* Title label *@
            <InputText class="form-control" @bind-Value="_recipe.Title" /> @* Bind to recipe.Title *@
        </div>

        <div class="mb-3">                                 @* Description input block *@
            <label class="form-label">Description</label>  @* Description label *@
            <InputTextArea class="form-control" @bind-Value="_recipe.Description" /> @* Bind to recipe.Description *@
        </div>

        <div class="mb-3">                                 @* Ingredients input block *@
            <label class="form-label">Ingredients</label>  @* Ingredients label *@
            <InputTextArea class="form-control" @bind-Value="_recipe.IngredientsText" /> @* Bind ingredients text *@
        </div>

        <div class="mb-3">                                 @* Steps input block *@
            <label class="form-label">Steps</label>        @* Steps label *@
            <InputTextArea class="form-control" @bind-Value="_recipe.StepsText" /> @* Bind steps text *@
        </div>

        <button class="btn btn-primary" type="submit" disabled="@_saving"> @* Save button *@
            @(_saving ? "Saving..." : "Save")              @* Text changes while saving *@
        </button>

        <a class="btn btn-secondary ms-2" href="/recipes/@RecipeId">Cancel</a> @* Cancel link *@
    </EditForm>
}

@code {
    [Parameter] public int RecipeId { get; set; }          // Recipe ID from the URL route

    private Recipe? _recipe;                               // The recipe shown in the form
    private bool _notLoggedIn;                             // True if session missing / not logged in
    private bool _canEdit;                                 // True if Admin OR Owner
    private bool _saving;                                  // True when save is running (prevents double submit)
    private string? _error;                                // Error message displayed on page

    protected override async Task OnInitializedAsync()      // Runs when page loads
    {
        var session = HttpAccessor.HttpContext?.Session;    // Try to read session safely

        if (session is null || !AuthSession.IsLoggedIn(session)) // If not logged in
        {
            _notLoggedIn = true;                            // Set not-logged-in state
            return;                                         // Stop loading
        }

        var isAdmin = AuthSession.IsAdmin(session);         // Check if current session is admin
        var userId = AuthSession.GetUserId(session);        // Get logged in user's id

        await using var db = await DbFactory.CreateDbContextAsync(); // Create db context safely

        _recipe = await db.Recipes                          // Query Recipes table
            .FirstOrDefaultAsync(r => r.RecipeId == RecipeId); // Find specific recipe

        if (_recipe is null)                                // If recipe missing
        {
            _error = "Recipe not found.";                   // Show error
            return;                                         // Stop
        }

        // Permission rule:
        // Admin -> can edit ANY recipe
        // User  -> can edit ONLY their own recipe
        _canEdit = isAdmin || (userId.HasValue && _recipe.UserId == userId.Value); // Set permission flag
    }

    private async Task SaveAsync()                           // Runs when user submits form
    {
        if (_saving) return;                                 // Prevent double submit
        _saving = true;                                      // Mark saving state
        _error = null;                                       // Clear old error

        try
        {
            var session = HttpAccessor.HttpContext?.Session;  // Read session safely

            if (session is null || !AuthSession.IsLoggedIn(session)) // If session lost
            {
                _notLoggedIn = true;                          // Show login prompt
                return;                                       // Stop
            }

            var isAdmin = AuthSession.IsAdmin(session);       // Admin flag
            var userId = AuthSession.GetUserId(session);      // User id

            await using var db = await DbFactory.CreateDbContextAsync(); // Create db context

            var dbRecipe = await db.Recipes                   // Load recipe from DB again (source of truth)
                .FirstOrDefaultAsync(r => r.RecipeId == RecipeId);

            if (dbRecipe is null)                             // If recipe deleted/missing
            {
                _error = "Recipe not found.";                 // Error
                return;                                       // Stop
            }

            // Re-check permission at save time (security)
            var canEdit = isAdmin || (userId.HasValue && dbRecipe.UserId == userId.Value); // Permission check
            if (!canEdit)                                     // If not allowed
            {
                _error = "You are not allowed to edit this recipe."; // Error
                return;                                       // Stop
            }

            // Update allowed fields
            dbRecipe.Title = _recipe!.Title;                  // Update title
            dbRecipe.Description = _recipe.Description;       // Update description
            dbRecipe.IngredientsText = _recipe.IngredientsText; // Update ingredients
            dbRecipe.StepsText = _recipe.StepsText;           // Update steps

            await db.SaveChangesAsync();                      // Save changes to DB

            Nav.NavigateTo($"/recipes/{RecipeId}", true);     // Go back to details page and force reload
        }
        catch (Exception ex)                                  // Catch any exception
        {
            _error = "Failed to save recipe: " + ex.Message;  // Show error
        }
        finally
        {
            _saving = false;                                  // Always reset saving state
        }
    }
}
