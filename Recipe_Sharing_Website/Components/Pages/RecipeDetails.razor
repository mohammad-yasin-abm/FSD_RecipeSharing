@page "/recipes/{Id:int}"                                  
@using Microsoft.EntityFrameworkCore                       @* EF Core *@
@using Recipe_Sharing_Website.Data                         @* AuthSession *@
@using Recipe_Sharing_Website.Models                       @* Models *@
@inject IHttpContextAccessor HttpAccessor                  
@inject IDbContextFactory<AppDbContext> DbFactory          
@inject NavigationManager Nav                              

@if (_recipe is null)
{
    <p>Loading...</p>
}
else
{
    <h2>@_recipe.Title</h2>

    <p>@_recipe.Description</p>

    <h5>Ingredients</h5>
    <p>@_recipe.IngredientsText</p>

    <h5>Steps</h5>
    <p>@_recipe.StepsText</p>

    @if (CanEditOrDelete)                                   @* Show buttons only if allowed *@
    {
        <a class="btn btn-warning me-2" href="/recipes/edit/@_recipe.RecipeId">Edit</a>
        <button class="btn btn-danger" @onclick="DeleteAsync">Delete</button>
    }

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <p class="text-danger mt-3">@_error</p>
    }
}

@code {
    [Parameter] public int Id { get; set; }                  // Recipe ID from URL

    private Recipe? _recipe;                                 // Loaded recipe
    private string? _error;                                  // Error message

    private bool CanEditOrDelete
    {
        get
        {
            var session = HttpAccessor.HttpContext?.Session;          // Read session
            if (session is null || !AuthSession.IsLoggedIn(session))  // Not logged in
                return false;

            if (AuthSession.IsAdmin(session))                          // Admin can edit/delete all
                return true;

            var userId = AuthSession.GetUserId(session);               // Get logged-in user id
            if (!userId.HasValue)                                      // If user id missing
                return false;

            return _recipe != null && _recipe.UserId == userId.Value; // Owner only
        }
    }

    protected override async Task OnInitializedAsync()        // Load recipe
    {
        await using var db = await DbFactory.CreateDbContextAsync(); // DB context
        _recipe = await db.Recipes.FirstOrDefaultAsync(r => r.RecipeId == Id); // Load recipe
        if (_recipe is null) _error = "Recipe not found.";    // Not found message
    }

    private async Task DeleteAsync()                          // Delete handler
    {
        try
        {
            var session = HttpAccessor.HttpContext?.Session;  // Session
            if (session is null || !AuthSession.IsLoggedIn(session)) // Must be logged in
            {
                Nav.NavigateTo("/login");                     // Redirect
                return;
            }

            var isAdmin = AuthSession.IsAdmin(session);       // Admin flag
            var userId = AuthSession.GetUserId(session);      // User id

            await using var db = await DbFactory.CreateDbContextAsync(); // DB

            var dbRecipe = await db.Recipes.FirstOrDefaultAsync(r => r.RecipeId == Id); // Fetch fresh
            if (dbRecipe is null)                              // Missing
            {
                _error = "Recipe not found.";
                return;
            }

            var canDelete = isAdmin || (userId.HasValue && dbRecipe.UserId == userId.Value); // Permission
            if (!canDelete)
            {
                _error = "You are not allowed to delete this recipe.";
                return;
            }

            db.Recipes.Remove(dbRecipe);                      // Delete
            await db.SaveChangesAsync();                      // Save

            Nav.NavigateTo("/recipes", true);                 // Back to list (refresh)
        }
        catch (Exception ex)
        {
            _error = "Delete failed: " + ex.Message;          // Error
        }
    }
}
