@page "/recipes/{Id:int}"
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@using Microsoft.EntityFrameworkCore
@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Nav

@if (_recipe is null && string.IsNullOrWhiteSpace(_error))
{
    <p>Loading...</p>
}
else if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}
else
{
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
            <h3 class="mb-0">@_recipe!.Title</h3>
            <small class="text-muted">by @_ownerName</small>
        </div>

        @if (CanDelete && !_confirmDelete)
        {
            <button class="btn btn-danger" @onclick="() => _confirmDelete = true">
                Delete Recipe
            </button>
        }
    </div>

    @if (CanDelete && _confirmDelete)
    {
        <div class="alert alert-warning mt-3">
            <b>Are you sure?</b> This will permanently delete the recipe and all feedback.
            <div class="mt-2 d-flex gap-2">
                <button class="btn btn-danger" @onclick="DeleteRecipeConfirmed">
                    Yes, delete
                </button>
                <button class="btn btn-secondary" @onclick="CancelDelete">
                    Cancel
                </button>
            </div>
        </div>
    }

    <p class="mt-3">@_recipe.Description</p>

    <h5>Ingredients</h5>
    @if (string.IsNullOrWhiteSpace(_recipe.IngredientsText))
    {
        <p class="text-muted">No ingredients listed.</p>
    }
    else
    {
        <pre style="white-space: pre-wrap;">@_recipe.IngredientsText</pre>
    }

    <h5>Steps</h5>
    @if (string.IsNullOrWhiteSpace(_recipe.StepsText))
    {
        <p class="text-muted">No steps provided.</p>
    }
    else
    {
        var steps = _recipe.StepsText
            .Split(new[] { "\r\n", "\n" }, StringSplitOptions.RemoveEmptyEntries)
            .Select(s => s.Trim())
            .Where(s => !string.IsNullOrWhiteSpace(s))
            .ToList();

        if (steps.Count == 0)
        {
            <p class="text-muted">No steps provided.</p>
        }
        else
        {
            <ol>
                @foreach (var s in steps)
                {
                    <li>@s</li>
                }
            </ol>
        }
    }

    <hr />

    <h5>Feedback</h5>

    @if (_feedbacks.Count == 0)
    {
        <p>No feedback yet.</p>
    }
    else
    {
        <ul>
            @foreach (var f in _feedbacks)
            {
                <li>
                    <b>@(f.Rating ?? 0)/5</b> – @f.Message
                </li>
            }
        </ul>
    }

    @if (IsOwner)
    {
        <div class="alert alert-info">
            You cannot rate your own recipe.
        </div>
    }
    else
    {
        <EditForm Model="_feedback" OnValidSubmit="AddFeedback" FormName="AddFeedbackForm">
            <InputNumber class="form-control mb-2" @bind-Value="_feedback.Rating" />
            <InputText class="form-control mb-2" @bind-Value="_feedback.Message" />
            <button class="btn btn-primary">Post</button>
        </EditForm>
    }
}

@code {
    [Parameter] public int Id { get; set; }

    private Recipe? _recipe;
    private List<Feedback> _feedbacks = new();
    private string? _error;
    private string _ownerName = "unknown";
    private bool _confirmDelete = false;

    private FeedbackVm _feedback = new();

    private int? CurrentUserId =>
        HttpContextAccessor.HttpContext?.Session.GetString(AuthSession.UserIdKey) is string s &&
        int.TryParse(s, out var id) ? id : null;

    private bool IsAdmin =>
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsAdmin(ctx.Session);

    private bool IsOwner =>
        CurrentUserId.HasValue && _recipe is not null && _recipe.UserId == CurrentUserId.Value;

    private bool CanDelete => IsOwner || IsAdmin;

    protected override async Task OnInitializedAsync()
    {
        await LoadAll();
    }

    private async Task LoadAll()
    {
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            _recipe = await db.Recipes
                .Include(r => r.User)
                .FirstOrDefaultAsync(r => r.RecipeId == Id);

            if (_recipe is null)
            {
                _error = "Recipe not found.";
                return;
            }

            _ownerName = _recipe.User?.Username ?? "unknown";

            _feedbacks = await db.Feedbacks
                .Where(f => f.RecipeId == Id)
                .OrderByDescending(f => f.CreatedAt)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task AddFeedback()
    {
        if (IsOwner)
        {
            _error = "You cannot rate your own recipe.";
            return;
        }

        if (!CurrentUserId.HasValue)
        {
            _error = "You must be logged in.";
            return;
        }

        await using var db = await DbFactory.CreateDbContextAsync();

        db.Feedbacks.Add(new Feedback
        {
            RecipeId = Id,
            UserId = CurrentUserId.Value,
            Rating = _feedback.Rating,
            Message = _feedback.Message ?? ""
        });

        await db.SaveChangesAsync();
        _feedback = new();
        await LoadAll();
    }

    private void CancelDelete() => _confirmDelete = false;

    private async Task DeleteRecipeConfirmed()
    {
        if (!CanDelete || _recipe is null)
            return;

        await using var db = await DbFactory.CreateDbContextAsync();

        var recipe = await db.Recipes.FirstOrDefaultAsync(r => r.RecipeId == Id);
        if (recipe is null)
            return;

        var feedbacks = await db.Feedbacks.Where(f => f.RecipeId == Id).ToListAsync();
        db.Feedbacks.RemoveRange(feedbacks);
        db.Recipes.Remove(recipe);

        await db.SaveChangesAsync();
        Nav.NavigateTo("/recipes", true);
    }

    private class FeedbackVm
    {
        public int? Rating { get; set; } = 5;
        public string? Message { get; set; }
    }
}
