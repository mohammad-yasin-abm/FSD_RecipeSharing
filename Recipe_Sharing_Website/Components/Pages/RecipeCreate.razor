@page "/recipes/create"
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Nav

<h3>Create Recipe</h3>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}

<EditForm Model="_vm" OnValidSubmit="CreateRecipe" FormName="CreateRecipeForm">
    <div class="mb-2">
        <label>Title</label>
        <InputText class="form-control" @bind-Value="_vm.Title" />
    </div>

    <div class="mb-2">
        <label>Description</label>
        <InputText class="form-control" @bind-Value="_vm.Description" />
    </div>

    <div class="mb-2">
        <label>Ingredients (type freely)</label>
        <InputTextArea class="form-control" rows="6" @bind-Value="_vm.IngredientsText" />
        <small class="text-muted">Example: 200g chicken, 2 cloves garlic, 1 tsp salt...</small>
    </div>

    <div class="mb-2">
        <label>Steps / Instructions</label>
        <InputTextArea class="form-control" rows="8" @bind-Value="_vm.StepsText" />
        <small class="text-muted">Tip: Put each step on a new line (Step 1, Step 2, ...)</small>
    </div>

    <button class="btn btn-primary" type="submit">Create</button>
</EditForm>

@code {
    private string? _error;

    private int? CurrentUserId =>
        HttpContextAccessor.HttpContext?.Session.GetString(AuthSession.UserIdKey) is string s &&
        int.TryParse(s, out var id) ? id : null;

    private RecipeVm _vm = new();

    private async Task CreateRecipe()
    {
        try
        {
            _error = null;

            if (!CurrentUserId.HasValue)
            {
                _error = "You must be logged in as a user to create recipes.";
                return;
            }

            if (string.IsNullOrWhiteSpace(_vm.Title))
            {
                _error = "Title is required.";
                return;
            }

            await using var db = await DbFactory.CreateDbContextAsync();

            var recipe = new Recipe
            {
                Title = _vm.Title.Trim(),
                Description = _vm.Description?.Trim(),
                IngredientsText = _vm.IngredientsText?.Trim(),
                StepsText = _vm.StepsText?.Trim(),
                UserId = CurrentUserId.Value
            };

            db.Recipes.Add(recipe);
            await db.SaveChangesAsync();

            Nav.NavigateTo($"/recipes/{recipe.RecipeId}", true);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private class RecipeVm
    {
        public string? Title { get; set; }
        public string? Description { get; set; }
        public string? IngredientsText { get; set; }
        public string? StepsText { get; set; }
    }
}
