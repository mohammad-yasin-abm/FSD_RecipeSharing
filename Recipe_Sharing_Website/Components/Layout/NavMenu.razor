@using Recipe_Sharing_Website.Data
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Nav

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">RecipeHub</a>
        <span class="ms-2 text-light">@DisplayName</span>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column">

        <div class="nav-item px-3 mt-2">
            <input class="form-control"
                   placeholder="Search recipes..."
                   @bind="_search"
                   @bind:event="oninput"
                   @onkeydown="HandleKeyDown" />
            <button class="btn btn-primary w-100 mt-2" @onclick="GoSearch">Search</button>
        </div>

        <div class="nav-item px-3 mt-3">
            <NavLink class="nav-link" href="/" Match="NavLinkMatch.All">Home</NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="/recipes">Recipes</NavLink>
        </div>

        @if (IsLoggedIn)
        {
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="/recipes/create">Add Recipe</NavLink>
            </div>

            <div class="nav-item px-3">
                <NavLink class="nav-link" href="/premium">Premium</NavLink>
            </div>

            @if (IsAdmin)
            {
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="/admin">Admin</NavLink>
                </div>
            }

            <div class="nav-item px-3">
                <form action="/auth/logout" method="post">
                    <button type="submit" class="nav-link btn btn-link p-0">Logout</button>
                </form>
            </div>
        }
        else
        {
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="/login">Login</NavLink>
            </div>

            <div class="nav-item px-3">
                <NavLink class="nav-link" href="/register">Register</NavLink>
            </div>
        }
    </nav>
</div>

@code {
    private string _search = "";

    private bool IsLoggedIn =>
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsLoggedIn(ctx.Session);

    private bool IsAdmin =>
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsAdmin(ctx.Session);

    private string DisplayName
    {
        get
        {
            if (HttpContextAccessor.HttpContext is not HttpContext ctx)
                return "";

            var name = ctx.Session.GetString(AuthSession.NameKey);
            return string.IsNullOrWhiteSpace(name) ? "" : $"({name})";
        }
    }

    private void GoSearch()
    {
        var q = (_search ?? "").Trim();
        if (string.IsNullOrWhiteSpace(q))
        {
            Nav.NavigateTo("/recipes", true);
            return;
        }

        var encoded = Uri.EscapeDataString(q);
        Nav.NavigateTo($"/recipes?q={encoded}", true);
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            GoSearch();
        }
    }
}
