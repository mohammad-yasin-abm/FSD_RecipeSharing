@page "/recipes/{Id:int}"
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode(prerender: false))

@using Microsoft.EntityFrameworkCore
@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Nav

@if (_recipe is null && string.IsNullOrWhiteSpace(_error))
{
    <p>Loading...</p>
}
else if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}
else
{
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
            <h3 class="mb-0">@_recipe!.Title</h3>
            <small class="text-muted">by @_ownerName</small>
            <div class="small mt-1">⭐ @_avgRatingText</div>
        </div>

        @if (IsOwner)
        {
            <div class="d-flex gap-2">
                <a class="btn btn-outline-primary" href="/recipes/edit/@Id">Edit</a>
            </div>
        }
    </div>

    <p class="mt-3">@_recipe.Description</p>

    <h5>Ingredients</h5>
    <pre style="white-space: pre-wrap;">@_recipe.IngredientsText</pre>

    <h5>Steps</h5>
    @if (_steps.Count == 0)
    {
        <p class="text-muted">No steps provided.</p>
    }
    else
    {
        <ol>
            @foreach (var s in _steps)
            {
                <li>@s</li>
            }
        </ol>
    }

    <hr />

    <h5>Feedback</h5>

    @if (_feedbacks.Count == 0)
    {
        <p>No feedback yet.</p>
    }
    else
    {
        <ul>
            @foreach (var f in _feedbacks)
            {
                <li><b>@(f.Rating ?? 0)/5</b> – @f.Message</li>
            }
        </ul>
    }

    @if (!CurrentUserId.HasValue)
    {
        <div class="alert alert-info">Please login to post feedback.</div>
    }
    else if (IsOwner)
    {
        <div class="alert alert-info">You cannot rate your own recipe.</div>
    }
    else if (!_canReview)
    {
        <div class="alert alert-info">You have already reviewed this recipe.</div>
    }
    else
    {
        <EditForm Model="_feedbackVm" OnValidSubmit="AddFeedback">
            <InputNumber class="form-control mb-2" @bind-Value="_feedbackVm.Rating" />
            <InputText class="form-control mb-2" @bind-Value="_feedbackVm.Message" />
            <button class="btn btn-primary">Post</button>
        </EditForm>
    }
}

@code {
    [Parameter] public int Id { get; set; }

    private Recipe? _recipe;
    private List<Feedback> _feedbacks = new();
    private List<string> _steps = new();
    private string? _error;

    private string _ownerName = "unknown";
    private string _avgRatingText = "—";

    private bool _canReview = true;

    private FeedbackVm _feedbackVm = new();

    private int? CurrentUserId =>
        HttpContextAccessor.HttpContext?.Session.GetString(AuthSession.UserIdKey) is string s &&
        int.TryParse(s, out var id) ? id : null;

    private bool IsOwner => CurrentUserId.HasValue && _recipe is not null && _recipe.UserId == CurrentUserId.Value;

    protected override async Task OnInitializedAsync()
    {
        await LoadAll();
    }

    private async Task LoadAll()
    {
        try
        {
            _error = null;
            await using var db = await DbFactory.CreateDbContextAsync();

            _recipe = await db.Recipes
                .Include(r => r.User)
                .FirstOrDefaultAsync(r => r.RecipeId == Id);

            if (_recipe is null)
            {
                _error = "Recipe not found.";
                return;
            }

            _ownerName = _recipe.User?.Username ?? "unknown";

            _steps = (_recipe.StepsText ?? "")
                .Split(new[] { "\r\n", "\n" }, StringSplitOptions.RemoveEmptyEntries)
                .Select(s => s.Trim())
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .ToList();

            _feedbacks = await db.Feedbacks
                .Where(f => f.RecipeId == Id)
                .OrderByDescending(f => f.CreatedAt)
                .ToListAsync();

            var avg = _feedbacks
                .Where(f => f.Rating != null)
                .Select(f => (double?)f.Rating)
                .Average();

            var count = _feedbacks.Count;

            _avgRatingText = avg.HasValue
                ? $"{avg.Value:0.0} ({count} reviews)"
                : $"— ({count} reviews)";

            if (CurrentUserId.HasValue)
            {
                _canReview = !await db.Feedbacks.AnyAsync(f => f.RecipeId == Id && f.UserId == CurrentUserId.Value);
            }
            else
            {
                _canReview = false;
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task AddFeedback()
    {
        if (!CurrentUserId.HasValue) return;
        if (IsOwner) return;

        await using var db = await DbFactory.CreateDbContextAsync();

        if (await db.Feedbacks.AnyAsync(f => f.RecipeId == Id && f.UserId == CurrentUserId.Value))
            return;

        db.Feedbacks.Add(new Feedback
        {
            RecipeId = Id,
            UserId = CurrentUserId.Value,
            Rating = _feedbackVm.Rating,
            Message = _feedbackVm.Message ?? ""
        });

        await db.SaveChangesAsync();

        _feedbackVm = new FeedbackVm();
        await LoadAll();
    }

    private class FeedbackVm
    {
        public int? Rating { get; set; } = 5;
        public string? Message { get; set; }
    }
}
