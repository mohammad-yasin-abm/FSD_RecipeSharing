@* Route for the premium subscription page *@
@page "/premium"

@* EF Core queries *@
@using Microsoft.EntityFrameworkCore

@* Project namespaces *@
@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models

@* DB factory injection *@
@inject IDbContextFactory<AppDbContext> DbFactory

@* Read session/auth info *@
@inject IHttpContextAccessor HttpContextAccessor

@* Used for redirects *@
@inject NavigationManager Nav

@* Page heading *@
<h3>Premium Membership</h3>

@* Show loading until user is fetched *@
@if (_user is null)
{
    <p>Loading...</p>
}
@* Show premium success if user already upgraded *@
else if (_user.IsPremium)
{
    <div class="alert alert-success">
        <strong>✅ You are a Premium Member</strong>
        <p>You have unlimited access to create and rate recipes.</p>
    </div>
}
@* Show upgrade options for non-premium users *@
else
{
    <div class="alert alert-info">
        <p>Upgrade to Premium to unlock:</p>
        <ul>
            <li>Unlimited recipe creation</li>
            <li>Unlimited recipe ratings</li>
        </ul>

        <button class="btn btn-primary" @onclick="PayForPremium">Upgrade to Premium</button>
    </div>
}

@code {
    // Current logged-in user
    private User? _user;

    // Component initialization: verify login & load user
    protected override async Task OnInitializedAsync()
    {
        if (HttpContextAccessor.HttpContext is not HttpContext ctx ||
            !AuthSession.IsLoggedIn(ctx.Session) ||
            AuthSession.IsAdmin(ctx.Session))
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        var userId = AuthSession.GetUserId(ctx.Session);
        if (userId is null)
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        await using var db = await DbFactory.CreateDbContextAsync();
        _user = await db.Users.FirstOrDefaultAsync(u => u.UserId == userId.Value);

        if (_user is null)
            Nav.NavigateTo("/login", true);
    }

    // Upgrade the user and record a payment
    private async Task PayForPremium()
    {
        if (_user is null) return;

        await using var db = await DbFactory.CreateDbContextAsync();

        var user = await db.Users.FirstAsync(u => u.UserId == _user.UserId);
        user.IsPremium = true;

        db.Payments.Add(new Payment
        {
            UserId = user.UserId,
            Amount = 9.99m,
            Status = "Success"
        });

        await db.SaveChangesAsync();

        _user.IsPremium = true;

        if (HttpContextAccessor.HttpContext is HttpContext ctx)
            ctx.Session.SetString(AuthSession.PremiumKey, "true");
    }
}
