@* Route for the ingredients admin page *@
@page "/ingredients"

@* Import EF Core for database queries *@
@using Microsoft.EntityFrameworkCore

@* Import project namespaces *@
@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models

@* Inject DB context factory *@
@inject IDbContextFactory<AppDbContext> DbFactory

@* Inject HttpContext to check admin rights *@
@inject IHttpContextAccessor HttpContextAccessor

@* Show access denied message if not admin *@
@if (!IsAdmin)
{
    <p><b>Access denied.</b> Admin only.</p>
}
@* Show ingredient UI if admin *@
else
{
    <h3>Ingredients Management</h3>

    @* Status message after actions *@
    @if (!string.IsNullOrWhiteSpace(_status))
    {
        <div class="alert alert-info">@_status</div>
    }

    <hr />

    <h5>Add Ingredient</h5>

    @* New ingredient form *@
    <EditForm Model="_newIngredient" OnSubmit="CreateIngredient" FormName="CreateIngredientForm">
        <div class="d-flex gap-2">
            <input class="form-control" @bind="_newIngredient.Name" placeholder="Ingredient name" />
            <button class="btn btn-primary" type="submit">Add</button>
        </div>
    </EditForm>

    <hr />

    <h5>All Ingredients (@_ingredients.Count)</h5>

    @* Search box *@
    <input class="form-control mb-2" @bind="_search" placeholder="Search..." />

    @* Ingredients table *@
    <table class="table table-sm align-middle">
        <thead>
            <tr>
                <th style="width:120px;">Id</th>
                <th>Name</th>
                <th style="width:260px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @* Loop filtered ingredient list *@
            @foreach (var ing in FilteredIngredients)
            {
                <tr>
                    <td>@ing.IngredientId</td>
                    <td>
                        @* If editing, show textbox *@
                        @if (_editId == ing.IngredientId)
                        {
                            <input class="form-control" @bind="_editName" />
                        }
                        @* Otherwise show plain name *@
                        else
                        {
                            @ing.Name
                        }
                    </td>
                    <td>
                        @* If editing, show Save/Cancel *@
                        @if (_editId == ing.IngredientId)
                        {
                            <button class="btn btn-sm btn-success" type="button" @onclick="SaveEdit">Save</button>
                            <button class="btn btn-sm btn-secondary ms-2" type="button" @onclick="CancelEdit">Cancel</button>
                        }
                        @* Otherwise show Edit/Delete *@
                        else
                        {
                            <button class="btn btn-sm btn-outline-primary" type="button" @onclick="() => StartEdit(ing)">Edit</button>
                            <button class="btn btn-sm btn-danger ms-2" type="button" @onclick="() => DeleteIngredient(ing.IngredientId)">Delete</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    // True if current user is admin
    private bool IsAdmin =>
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsAdmin(ctx.Session);

    // Full ingredient list
    private List<Ingredient> _ingredients = new();

    // Status success/error/info message
    private string? _status;

    // Search text
    private string _search = string.Empty;

    // Currently edited ingredient ID
    private int? _editId;

    // Temporary editable ingredient name
    private string _editName = string.Empty;

    // View model for create form
    private NewIngredientVm _newIngredient = new();

    // Load list on component init
    protected override async Task OnInitializedAsync()
    {
        if (!IsAdmin) return;
        await LoadIngredients();
    }

    // Retrieve ingredients from DB
    private async Task LoadIngredients()
    {
        await using var db = DbFactory.CreateDbContext();

        _ingredients = await db.Ingredients
            .OrderBy(i => i.Name)
            .ToListAsync();
    }

    // Filtered list based on search
    private IEnumerable<Ingredient> FilteredIngredients =>
        string.IsNullOrWhiteSpace(_search)
            ? _ingredients
            : _ingredients.Where(i => (i.Name ?? "").Contains(_search, StringComparison.OrdinalIgnoreCase));

    // Create a new ingredient
    private async Task CreateIngredient()
    {
        if (!IsAdmin) return;

        var name = (_newIngredient.Name ?? "").Trim();
        if (string.IsNullOrWhiteSpace(name))
        {
            _status = "Ingredient name cannot be empty.";
            return;
        }

        await using var db = DbFactory.CreateDbContext();

        var exists = await db.Ingredients.AnyAsync(i => i.Name.ToLower() == name.ToLower());
        if (exists)
        {
            _status = $"Ingredient '{name}' already exists.";
            return;
        }

        db.Ingredients.Add(new Ingredient { Name = name });
        await db.SaveChangesAsync();

        _newIngredient = new();
        _status = $"Added ingredient '{name}'.";
        await LoadIngredients();
    }

    // Start editing selected ingredient
    private void StartEdit(Ingredient ing)
    {
        _editId = ing.IngredientId;
        _editName = ing.Name ?? "";
        _status = null;
    }

    // Cancel edit mode
    private void CancelEdit()
    {
        _editId = null;
        _editName = "";
    }

    // Save updated ingredient name
    private async Task SaveEdit()
    {
        if (!IsAdmin || _editId is null) return;

        var name = (_editName ?? "").Trim();
        if (string.IsNullOrWhiteSpace(name))
        {
            _status = "Ingredient name cannot be empty.";
            return;
        }

        await using var db = DbFactory.CreateDbContext();

        var exists = await db.Ingredients.AnyAsync(i =>
            i.IngredientId != _editId.Value &&
            i.Name.ToLower() == name.ToLower());

        if (exists)
        {
            _status = $"Another ingredient already has the name '{name}'.";
            return;
        }

        var ing = await db.Ingredients.FindAsync(_editId.Value);
        if (ing is null) return;

        ing.Name = name;
        await db.SaveChangesAsync();

        _status = $"Updated ingredient #{_editId.Value}.";
        _editId = null;
        _editName = "";
        await LoadIngredients();
    }

    // Delete ingredient if not used in recipes
    private async Task DeleteIngredient(int ingredientId)
    {
        if (!IsAdmin) return;

        await using var db = DbFactory.CreateDbContext();

        var inUse = await db.RecipeIngredients.AnyAsync(ri => ri.IngredientId == ingredientId);
        if (inUse)
        {
            _status = $"Cannot delete ingredient #{ingredientId} because it is used in recipes.";
            return;
        }

        var ing = await db.Ingredients.FindAsync(ingredientId);
        if (ing is null) return;

        db.Ingredients.Remove(ing);
        await db.SaveChangesAsync();

        _status = $"Deleted ingredient #{ingredientId}.";
        await LoadIngredients();
    }

    // Internal model used to bind create form
    private class NewIngredientVm
    {
        public string? Name { get; set; }
    }
}
