@page "/recipes"                                           
@using Recipe_Sharing_Website.Data                         @* AuthSession *@
@using Recipe_Sharing_Website.Models                       @* Models *@
@inject IHttpContextAccessor HttpAccessor                  
@inject IDbContextFactory<AppDbContext> DbFactory          
@inject NavigationManager Nav                              

<h2>Recipes</h2>                                            @* Title *@

@if (!string.IsNullOrWhiteSpace(_error))                    @* Error block *@
{
    <p class="text-danger">@_error</p>
}
else if (_recipes is null)                                  @* Loading block *@
{
    <p>Loading...</p>
}
else                                                        @* Show recipes *@
{
    <ul>
        @foreach (var r in _recipes)
        {
            <li class="mb-2">
                <a href="/recipes/@r.RecipeId">@r.Title</a>

                @if (CanEditOrDelete(r))                     @* Only show if allowed *@
                {
                    <a class="btn btn-sm btn-warning ms-2" href="/recipes/edit/@r.RecipeId">Edit</a>
                    <button class="btn btn-sm btn-danger ms-1" @onclick="() => DeleteFromListAsync(r.RecipeId)">Delete</button>
                }
            </li>
        }
    </ul>
}

@code {
    private List<Recipe>? _recipes;                          // Recipe list
    private string? _error;                                  // Error text

    protected override async Task OnInitializedAsync()       // Load on start
    {
        await LoadAsync();                                   // Load recipes
    }

    private async Task LoadAsync()                            // Loads recipes from DB
    {
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync(); // Get db context
            _recipes = await db.Recipes                       // Query recipes
                .OrderByDescending(r => r.RecipeId)           // Newest first
                .ToListAsync();                               // Execute
        }
        catch (Exception ex)
        {
            _error = "Failed to load recipes: " + ex.Message; // Show error
        }
    }

    private bool CanEditOrDelete(Recipe r)                    // Permission check
    {
        var session = HttpAccessor.HttpContext?.Session;      // Get session
        if (session is null || !AuthSession.IsLoggedIn(session)) // Not logged in
            return false;                                     // No buttons

        if (AuthSession.IsAdmin(session))                     // Admin sees all buttons
            return true;

        var userId = AuthSession.GetUserId(session);          // Get user id
        if (!userId.HasValue)                                 // If missing
            return false;                                     // No buttons

        return r.UserId == userId.Value;                      // Owner only
    }

    private async Task DeleteFromListAsync(int recipeId)      // Delete handler
    {
        try
        {
            var session = HttpAccessor.HttpContext?.Session;  // Read session
            if (session is null || !AuthSession.IsLoggedIn(session)) // Not logged in
            {
                Nav.NavigateTo("/login");                     // Redirect
                return;
            }

            var isAdmin = AuthSession.IsAdmin(session);       // Admin check
            var userId = AuthSession.GetUserId(session);      // User id

            await using var db = await DbFactory.CreateDbContextAsync(); // Create db

            var dbRecipe = await db.Recipes.FirstOrDefaultAsync(r => r.RecipeId == recipeId); // Find recipe
            if (dbRecipe is null)                             // Not found
            {
                _error = "Recipe not found.";
                return;
            }

            var canDelete = isAdmin || (userId.HasValue && dbRecipe.UserId == userId.Value); // Permission
            if (!canDelete)
            {
                _error = "You are not allowed to delete this recipe.";
                return;
            }

            db.Recipes.Remove(dbRecipe);                      // Remove
            await db.SaveChangesAsync();                      // Save
            await LoadAsync();                                // Reload list
        }
        catch (Exception ex)
        {
            _error = "Delete failed: " + ex.Message;
        }
    }
}
