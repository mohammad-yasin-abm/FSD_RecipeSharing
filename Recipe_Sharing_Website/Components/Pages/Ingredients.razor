@page "/ingredients"
 

@using Microsoft.EntityFrameworkCore
@using Recipe_Sharing_Website.Data
@using Recipe_Sharing_Website.Models

@inject IDbContextFactory<AppDbContext> DbFactory
@inject IHttpContextAccessor HttpContextAccessor

@if (!IsAdmin)
{
    <p><b>Access denied.</b> Admin only.</p>
}
else
{
    <h3>Ingredients Management</h3>

    @if (!string.IsNullOrWhiteSpace(_status))
    {
        <div class="alert alert-info">@_status</div>
    }

    <hr />

    <h5>Add Ingredient</h5>
    <EditForm Model="_newIngredient" OnSubmit="CreateIngredient" FormName="CreateIngredientForm">
        <div class="d-flex gap-2">
            <input class="form-control" @bind="_newIngredient.Name" placeholder="Ingredient name" />
            <button class="btn btn-primary" type="submit">Add</button>
        </div>
    </EditForm>

    <hr />

    <h5>All Ingredients (@_ingredients.Count)</h5>

    <input class="form-control mb-2" @bind="_search" placeholder="Search..." />

    <table class="table table-sm align-middle">
        <thead>
            <tr>
                <th style="width:120px;">Id</th>
                <th>Name</th>
                <th style="width:260px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var ing in FilteredIngredients)
            {
                <tr>
                    <td>@ing.IngredientId</td>
                    <td>
                        @if (_editId == ing.IngredientId)
                        {
                            <input class="form-control" @bind="_editName" />
                        }
                        else
                        {
                            @ing.Name
                        }
                    </td>
                    <td>
                        @if (_editId == ing.IngredientId)
                        {
                            <button class="btn btn-sm btn-success" type="button" @onclick="SaveEdit">Save</button>
                            <button class="btn btn-sm btn-secondary ms-2" type="button" @onclick="CancelEdit">Cancel</button>
                        }
                        else
                        {
                            <button class="btn btn-sm btn-outline-primary" type="button" @onclick="() => StartEdit(ing)">Edit</button>
                            <button class="btn btn-sm btn-danger ms-2" type="button" @onclick="() => DeleteIngredient(ing.IngredientId)">Delete</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private bool IsAdmin =>
        HttpContextAccessor.HttpContext is HttpContext ctx &&
        AuthSession.IsAdmin(ctx.Session);

    private List<Ingredient> _ingredients = new();
    private string? _status;

    private string _search = string.Empty;
    private int? _editId;
    private string _editName = string.Empty;

    private NewIngredientVm _newIngredient = new();

    protected override async Task OnInitializedAsync()
    {
        if (!IsAdmin) return;
        await LoadIngredients();
    }

    private async Task LoadIngredients()
    {
        await using var db = DbFactory.CreateDbContext();

        _ingredients = await db.Ingredients
            .OrderBy(i => i.Name)
            .ToListAsync();
    }

    private IEnumerable<Ingredient> FilteredIngredients =>
        string.IsNullOrWhiteSpace(_search)
            ? _ingredients
            : _ingredients.Where(i => (i.Name ?? "").Contains(_search, StringComparison.OrdinalIgnoreCase));

    private async Task CreateIngredient()
    {
        if (!IsAdmin) return;

        var name = (_newIngredient.Name ?? "").Trim();
        if (string.IsNullOrWhiteSpace(name))
        {
            _status = "Ingredient name cannot be empty.";
            return;
        }

        await using var db = DbFactory.CreateDbContext();

        var exists = await db.Ingredients.AnyAsync(i => i.Name.ToLower() == name.ToLower());
        if (exists)
        {
            _status = $"Ingredient '{name}' already exists.";
            return;
        }

        db.Ingredients.Add(new Ingredient { Name = name });
        await db.SaveChangesAsync();

        _newIngredient = new();
        _status = $"Added ingredient '{name}'.";
        await LoadIngredients();
    }

    private void StartEdit(Ingredient ing)
    {
        _editId = ing.IngredientId;
        _editName = ing.Name ?? "";
        _status = null;
    }

    private void CancelEdit()
    {
        _editId = null;
        _editName = "";
    }

    private async Task SaveEdit()
    {
        if (!IsAdmin || _editId is null) return;

        var name = (_editName ?? "").Trim();
        if (string.IsNullOrWhiteSpace(name))
        {
            _status = "Ingredient name cannot be empty.";
            return;
        }

        await using var db = DbFactory.CreateDbContext();

        var exists = await db.Ingredients.AnyAsync(i =>
            i.IngredientId != _editId.Value &&
            i.Name.ToLower() == name.ToLower());

        if (exists)
        {
            _status = $"Another ingredient already has the name '{name}'.";
            return;
        }

        var ing = await db.Ingredients.FindAsync(_editId.Value);
        if (ing is null) return;

        ing.Name = name;
        await db.SaveChangesAsync();

        _status = $"Updated ingredient #{_editId.Value}.";
        _editId = null;
        _editName = "";
        await LoadIngredients();
    }

    private async Task DeleteIngredient(int ingredientId)
    {
        if (!IsAdmin) return;

        await using var db = DbFactory.CreateDbContext();

        var inUse = await db.RecipeIngredients.AnyAsync(ri => ri.IngredientId == ingredientId);
        if (inUse)
        {
            _status = $"Cannot delete ingredient #{ingredientId} because it is used in recipes.";
            return;
        }

        var ing = await db.Ingredients.FindAsync(ingredientId);
        if (ing is null) return;

        db.Ingredients.Remove(ing);
        await db.SaveChangesAsync();

        _status = $"Deleted ingredient #{ingredientId}.";
        await LoadIngredients();
    }

    private class NewIngredientVm
    {
        public string? Name { get; set; }
    }
}
